
<div class="container mt-4">
  <!-- Select Type Selection-->
   <br>
   <br>
  <div class="mb-3">
    <label for="typeSelect" class="form-label">Type:</label>
    <select id="typeSelect" class="form-select" style="width: 200px; display: inline-block;">
      <option value="">Select Type</option>
      <option value="bus-performance">Bus Performance</option>
      <option value="expenses">Expenses</option>
      <option value="summary">Summary</option>
    </select>
    <!-- Date range -->
    <label for="startDate" class="form-label ms-3">Start Date:</label>
    <input type="date" id="startDate" class="form-control" style="width: 200px; display: inline-block;" />

    <label for="endDate" class="form-label ms-3">End Date:</label>
    <input type="date" id="endDate" class="form-control" style="width: 200px; display: inline-block;" />
    <br>
    <br>
    <h2>Bus Range</h2>
    <label for="startBus" class="form-label ms-3">From:</label>
    <select name="startBus" id="startBus"  class="form-select" style="width: 300px; display: inline-block;"></select>
    <label for="stopBus" class="form-label ms-3">To:</label>
    <select name="stopBus" id="stopBus"  class="form-select" style="width: 300px; display: inline-block;"></select>
    <br>
    <br>

    <button id="btnLoadReport" class="btn btn-primary" disabled><i class="fas fa-chart-line"></i> Load Report</button>
  </div>


  <div id="reportInfoSection" style="display: none;" class="mb-4">
    <h4>Report Info: <span id="reportHeader"></span></h4>
    <p><strong>Report Type:</strong> <span>Bus Performance</span></p>
    <p><strong>Bus Range:</strong> <span id="busRange"></span></p>
    <p><strong>Report Date:</strong> <span id="reportDate"></span></p>
  </div>

  <!-- Bus Performance Breakdown -->
  <div id="reportBreakdownSection" style="display: none;">
    <h4>Bus Performance Breakdown:</h4>
    <table class="table">
      <thead>
      <tr>
        <th>Name</th>
        <th>Passengers </th>
        <th>Passenger Income</th>
        <th>Fuel</th>
        <th>Maintenance</th>
        <th>Net Income</th>
      </tr>
      </thead>
      <tbody id="reportBreakdownBody">
      <!-- filled by JS -->
      </tbody>
    </table>
    <button type="button" style ="display:none" id="printReportButton">Print Report</button>
  </div>

  <script>
    function naira(amount) {
  return `â‚¦${amount.toLocaleString('en-NG')}`;
    }

    function formatDateLong(dateStr) {
        const date = new Date(dateStr);
        const day = date.getDate();

        const getOrdinal = (n) => {
          if (n > 3 && n < 21) return 'th';
          switch (n % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
          }
        };

        const month = date.toLocaleString('default', { month: 'long' });
        const year = date.getFullYear();

        return `${day}${getOrdinal(day)} ${month} ${year}`;
      }
  async function customAlert(message, options = {}) {
    return new Promise((resolve) => {
      const customAlert = document.getElementById('custom-alert');
      const customAlertMessage = document.getElementById('custom-alert-message');
      const customAlertOk = document.getElementById('custom-alert-ok');
      const customAlertCancel = document.getElementById('custom-alert-cancel');

      customAlertMessage.innerText = message;

      if (options.confirm) {
        customAlertCancel.style.display = 'inline-block';
      } else {
        customAlertCancel.style.display = 'none';
      }

      customAlert.style.display = 'block';
      setTimeout(() => {
        customAlert.classList.add('show');
      }, 10);

      customAlertOk.addEventListener('click', () => {
        customAlert.classList.remove('show');
        setTimeout(() => {
          customAlert.style.display = 'none';
          resolve(true);
        }, 500);
      });

      customAlertCancel.addEventListener('click', () => {
        customAlert.classList.remove('show');
        setTimeout(() => {
          customAlert.style.display = 'none';
          resolve(false);
        }, 500);
      });
    });
  }

  async function exportToPDF() {
      const { jsPDF } = window.jspdf;

      const container = document.getElementById("reportContainer");
      const canvas = await html2canvas(container, { scale: 2 });

      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgRatio = imgProps.width / imgProps.height;
      const pdfWidth = pageWidth;
      const pdfHeight = pageWidth / imgRatio;

      let position = 10;
      if (pdfHeight > pageHeight) {
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      } else {
        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
      }

      pdf.save('daily_financial_report.pdf');
    }

    const selectType = document.getElementById('typeSelect');
      const reportButton = document.getElementById('btnLoadReport');

      selectType.addEventListener('change', () => {
        if (selectType.value !== '') {
          reportButton.disabled = false;
        } else {
          reportButton.disabled = true;
        }
      });

    function loadReportPage() {
     // 2) On "Load Report" => call getDetailedReport()
      document.getElementById("btnLoadReport").addEventListener("click", function() {
        // clearExistingData();
        getDetailedReport();
        button.disabled = true;
      });
    }
async function loadDropdowns() {
        try {
          const data = await fetch(API_URL + "vehicles");
          const buses = await data.json();
          const startBus = document.getElementById("startBus");
          const stopBus = document.getElementById("stopBus");
          buses.forEach(d => {
              let opt = document.createElement("option");
              opt.value = d.name;
              opt.textContent = `PMT${d.name}`; 
              startBus.appendChild(opt);
            });
            buses.forEach(d => {
              let opt = document.createElement("option");
              opt.value = d.name;
              opt.textContent = `PMT${d.name}` 
              stopBus.appendChild(opt);
            });
        }
       catch(error) {
        console.log(error)
          customAlert("Failed to load Vehicles.");
       } 
      }

    loadDropdowns()

    function hideDashboardSections() {
        const elementIds = [

          "reportInfoSection",
          "reportBreakdownSection",
          "summaryInfoSection"
        ];

        elementIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = "none";
        });

        // Remove elements with class "myRow" using jQuery
        if ($('.myRow').length) {
          $('.myRow').remove();
        }
      }

    async function getDetailedReport() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const type = document.getElementById("typeSelect").value;
      const startBus = document.getElementById("startBus").value;
      const stopBus = document.getElementById("stopBus").value;

      if (!startDate || !endDate ) {
        customAlert("Please select a date range.");
        return;
      }
      let endpoint = API_URL + "reports/" + `${type}` + `/?startDate=${startDate}&endDate=${endDate}
      &startBus=${startBus}&stopBus=${stopBus}`;
      if(!type) {
        customAlert("Please select a valid type.");
        return;
      }
          if (type === "bus-performance") {
            try {
              const res = await fetch(endpoint, {
                  method: "GET", 
                  headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`  
                  }
            });
            const data = await res.json();
          // If no participants or error
          hideDashboardSections()
          if (data.error) {
            customAlert(data.error);
            return;
          }
          // Show result details
          document.getElementById("reportInfoSection").style.display = "block";
          document.getElementById("reportHeader").textContent = `From ${formatDateLong(startDate)} to ${formatDateLong(endDate)}`;
          document.getElementById("busRange").textContent = `PMT${startBus} to PMT${stopBus}`;
          document.getElementById("reportDate").textContent = formatDateLong(Date.now());
          document.getElementById("reportBreakdownSection").style.display = "block";
          const breakdownBody = document.getElementById("reportBreakdownBody");
          (data || []).forEach(d => {
            let row = document.createElement("tr");
            row.setAttribute("class", "myRow");
            let tdName = document.createElement("td");
            tdName.textContent = `PMT${d.bus}`;
            let tdIncome = document.createElement("td");
            tdIncome.textContent = naira(d.totalIncome);
            let tdPassengers = document.createElement("td");
            tdPassengers.textContent = d.passengers;  
            let tdExpenses = document.createElement("td");
            tdExpenses.textContent = naira(d.expenses);
            let tdNet = document.createElement("td");
            tdNet.textContent = naira(d.netIncome);
            let tdFuel = document.createElement("td");
            tdFuel.textContent = naira(d.fuel);
            row.appendChild(tdName);
            row.appendChild(tdPassengers);
            row.appendChild(tdIncome)
            row.appendChild(tdFuel);
            row.appendChild(tdExpenses);
            row.appendChild(tdNet);
            breakdownBody.appendChild(row);
          });  
          //create button to print to PDF
          const printButton = document.getElementById("printReportButton");
          printButton.style.display = "block";
          printButton.textContent = "Print Report";
          printButton.classList.add("btn", "btn-primary");
          printButton.onclick = function() {
            window.print();
          };
          }
          catch (err) {
            console.log(err);
            customAlert(err);
          }
        }
        else if (type === "expenses") {
          try {
          
          }
          catch(error) {
              customAlert(error);
              console.log(error)
              return
          }
        }
        else if(type === "summary") {
          try {
        
          }
          catch(error) {
            customAlert(error)
            return
          }
        }
        else if(type === "daily") {
          try {
            
          }
          catch (error) {
            customAlert(error);
            return
          }

        }
        }
       
  </script>
<script>
    /* Re-init DataTable after dynamic load if needed */
    setTimeout(loadReportPage(), 100);
</script>
  
