<!-- pages/Expenses.html -->
<div class="container mt-4">
    <h2>Manage Bus Expenses</h2>
    
    <div class="mb-3">
      <button class="btn btn-primary" id="btnaddExpense" onclick="addExpense();">
        + Add Bus Expenses
      </button>
    </div>
    
    <!-- DataTable -->
    <table
      id="expenseTable"
      class="display nowrap table table-striped"
      style="width: 100%;"
    >
      <thead>
        <tr>
          <th>S/N</th>
          <th>Vehicle ID</th>
          <th>Amount</th>
          <th>Date</th>
          <th>Created By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Loaded via DataTables Ajax -->
      </tbody>
    </table>
    </div>
    <!-- Modal: Add/Edit Expense -->
    <div
      class="modal fade"
      id="expenseModal"
      tabindex="-1"
      aria-labelledby="ExpenseModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="studentForm">
            <div class="modal-header">
              <h5 class="modal-title" id="ExpenseModalLabel">Add Bus Expenses</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="expenseId" />
    
              <!-- Title -->
              <div class="mb-3">
                <label for="title" class="form-label"
                  >Vehicle</label
                >
                <select name="busSelect" id="busSelect" class="form-select" required></select>
              </div>
    
              <!-- Items (Array of Description and Amount) -->
              <div class="mb-3">
                <label class="form-label">Expense Items</label>
                <div id="expenseItems">
                  <div class="row mb-2 expense-item-row">
                    <div class="col-7">
                      <input type="text" class="form-control item-description" placeholder="Description" required />
                    </div>
                    <div class="col-4">
                      <input type="number" class="form-control item-amount" placeholder="Amount" required />
                    </div>
                    <div class="col-1 d-flex align-items-center">
                      <button type="button" class="btn btn-danger btn-sm remove-item" onclick="removeExpenseItem(this)">&times;</button>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addExpenseItem()">+ Add Item</button>
              </div>
    
              <!-- Source -->
              <div class="mb-3">
                <label for="source" class="form-label">Source</label>
                <select id="source" class="form-select" required>
                    <option value ="Cash"> Cash</option>
                    <option value ="Bank"> Bank</option>
                    <option value ="POS"> POS</option>
                    <option value ="Mobile Transfers"> Mobile Transfers</option>
                    <option value ="Other"> Other</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-success" onclick="saveExpense()">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    

    <script>
         function naira(amount) {
  return `â‚¦${amount.toLocaleString('en-NG')}`;
}
  function formatDateLong(dateStr) {
    const date = new Date(dateStr);
    const day = date.getDate();

    const getOrdinal = (n) => {
      if (n > 3 && n < 21) return 'th';
      switch (n % 10) {
        case 1: return 'st';
        case 2: return 'nd';
        case 3: return 'rd';
        default: return 'th';
      }
    };

    const month = date.toLocaleString('default', { month: 'long' });
    const year = date.getFullYear();

    return `${day}${getOrdinal(day)} ${month} ${year}`;
  }
     async function customAlert(message, options = {}) {
        return new Promise((resolve) => {
          const customAlert = document.getElementById('custom-alert');
          const customAlertMessage = document.getElementById('custom-alert-message');
          const customAlertOk = document.getElementById('custom-alert-ok');
          const customAlertCancel = document.getElementById('custom-alert-cancel');

          customAlertMessage.innerText = message;

          if (options.confirm) {
            customAlertCancel.style.display = 'inline-block';
          } else {
            customAlertCancel.style.display = 'none';
          }

          customAlert.style.display = 'block';
          setTimeout(() => {
            customAlert.classList.add('show');
          }, 10);

          customAlertOk.addEventListener('click', () => {
            customAlert.classList.remove('show');
            setTimeout(() => {
              customAlert.style.display = 'none';
              resolve(true);
            }, 500);
          });

          customAlertCancel.addEventListener('click', () => {
            customAlert.classList.remove('show');
            setTimeout(() => {
              customAlert.style.display = 'none';
              resolve(false);
            }, 500);
          });
        });
      }
    

      document.addEventListener("DOMContentLoaded", function () {
        initDataTable();
        // Form Submits
        document.getElementById("studentForm").addEventListener("submit", function (e) {
          e.preventDefault();
          saveExpense();
        });
        document.getElementById("importCSVForm").addEventListener("submit", function (e) {
          e.preventDefault();
          importCSV();
        });
      });
    
      function addExpense() {
        clearExpensesForm();
        document.getElementById("ExpenseModalLabel").textContent = "Add Expense";
        loadDropdowns(); // load buses from API
        new bootstrap.Modal(document.getElementById("expenseModal")).show();
      }
    
      function startimportCSV() {
        document.getElementById("csvFile").value = "";
        new bootstrap.Modal(document.getElementById("importCSVModal")).show();
      }
    

      function initDataTable() {
        function dateToString(date) {
          return new Date(date).toLocaleDateString();
      }
        expenseTable = $("#expenseTable").DataTable({
          processing: true,
          ajax: {
            url: API_URL + "bus-expenses",
            dataSrc: ""
          },
          columns: [
            {
      data: null,
      render: function(data, type, row, meta) {
        return meta.row + 1;
      }
    },
            { data: function (row) {
              return `PMT${row.vehicleId.name}`;
            }},
            { data: function(row) {
            let grandTotal = 0;
            row.expensesItems.map(item => {
              const total = item.amount;
              grandTotal += total;
              return total;
            });
            return naira(grandTotal);
          }},
            { data: function (row) {
              return formatDateLong(row.transDate)
            }},
            { data: "createdBy.username"},
            {
              data: null,
              render: function (row) {
                return `
                  <button class="btn btn-sm btn-primary me-1" onclick="editExpense(${"'" + row._id + "'" })">
                    Edit
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteExpense(${"'" + row._id + "'"})">
                    Delete
                  </button>
                `;
              },
              orderable: false
            }
          ],
          dom: "Bfrtip",
          buttons: [
            "pageLength",
            { extend: "csvHtml5", title: "Expenses_Export" },
            { extend: "excelHtml5", title: "Expenses_Export" },
            { extend: "print", title: "Expenses List" }
          ],
          responsive: true,
          pageLength: 10,
          lengthMenu: [
            [10, 25, 50, 100, -1],
            [10, 25, 50, 100, "All"]
          ]
        });
      }
    
      // Clear Form
      function clearExpensesForm() {
        document.getElementById("expenseId").value = "";
        document.getElementById("busSelect").value = "";
        document.getElementById("expenseItems").value = "";
        // document.getElementById("amount").value = "";
        document.getElementById("source").value = "";
        document.getElementById("expenseItems").innerHTML = `
          <div class="row mb-2 expense-item-row">
            <div class="col-7">
              <input type="text" class="form-control item-description" placeholder="Description" required />
            </div>
            <div class="col-4">
              <input type="number" class="form-control item-amount" placeholder="Amount" required />
            </div>
            <div class="col-1 d-flex align-items-center">
              <button type="button" class="btn btn-danger btn-sm remove-item" onclick="removeExpenseItem(this)">&times;</button>
            </div>
          </div>
        `;
      }
    
      // Load Category dropdown
      function loadDropdowns(selectedCat) {
    
        fetch(API_URL + "vehicles")
          .then((res) => res.json())
          .then((buses) => {
            const busSel = document.getElementById("busSelect");
            buses.forEach(d => {
              let opt = document.createElement("option");
              opt.value = `${d.name}:${d._id}`;
              opt.textContent = `PMT${d.name}`;
              busSel.appendChild(opt);
            });
          })
          .catch(() => customAlert("Failed to load Vehicles."));
      }
    
      window.editExpense = function (id) {
        fetch(API_URL + "expenses/" + id)
          .then((res) => res.json())
          .then((expense) => {
            document.getElementById("expenseId").value = expense._id;
            document.getElementById("title").value = expense.title;
            document.getElementById("description").value = expense.description;
            document.getElementById("amount").value = expense.amount;
            document.getElementById("source").value = expense.source;
            loadDropdowns();
    
            document.getElementById("ExpenseModalLabel").textContent =
              "Edit Expense";
            new bootstrap.Modal(document.getElementById("expenseModal")).show();
          })
          .catch(() => customAlert("Failed to fetch Expense."));
      };
    
      // Add JS for dynamic expense items
function addExpenseItem() {
  const container = document.getElementById('expenseItems');
  const row = document.createElement('div');
  row.className = 'row mb-2 expense-item-row';
  row.innerHTML = `
    <div class="col-7">
      <input type="text" class="form-control item-description" placeholder="Description" required />
    </div>
    <div class="col-4">
      <input type="number" class="form-control item-amount" placeholder="Amount" required />
    </div>
    <div class="col-1 d-flex align-items-center">
      <button type="button" class="btn btn-danger btn-sm remove-item" onclick="removeExpenseItem(this)">&times;</button>
    </div>
  `;
  container.appendChild(row);
}
function removeExpenseItem(btn) {
  const row = btn.closest('.expense-item-row');
  if (row) row.remove();
}

// Save Expense
      async function saveExpense() {
        const items = Array.from(document.querySelectorAll('#expenseItems .expense-item-row')).map(row => ({
          item: row.querySelector('.item-description').value.trim(),
          amount: parseFloat(row.querySelector('.item-amount').value)
        })).filter(item => item.item && !isNaN(item.amount));
        const payload = {
          source: document.getElementById("source").value.trim(),
          vehicleId: document.getElementById("busSelect").value.split(':')[1],
          name: document.getElementById("busSelect").value.split(':')[0],
          expensesItems: items
        };
        console.log(payload)
          try {
            const token = localStorage.getItem("token");
            const res = await fetch(API_URL + "bus-expenses", {
            method: "POST",
            headers: { "Content-Type": "application/json", 
                    "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                  });
            const body = await res.json();
              if(body.error) return customAlert(body.error)
              bootstrap.Modal.getInstance(
                document.getElementById("expenseModal")
              ).hide();
              customAlert("Expense added successfully.");
              expenseTable.ajax.reload(null, false);
        }
          
            catch(error) {
              customAlert(error)
          console.error("Error saving expense:", error);
          bootstrap.Modal.getInstance(document.getElementById("expenseModal")).hide();
            }
      }
      async function deleteExpense(id) {
    const proceed = await customAlert('Are you sure you want to delete this expense?', { confirm: true })
        if (!proceed) return
    fetch(API_URL + "expenses/" + id, {
      method: "DELETE",
      headers: { "Content-Type": "application/json", 
                "Authorization": `Bearer ${token}`
              }
    })
      .then((res) => res.json())
      .then((data) => {
        if(data.error) return customAlert(data.error)
        customAlert(data.message || "Expense deleted successfully.");
        expenseTable.ajax.reload(null, false);
      })
      .catch(() => customAlert("Failed to delete expense."));
  }
     
    
    </script>
    <script>
      /* Re-init DataTable after dynamic load if needed */
      setTimeout(initDataTable, 100);
    </script>

