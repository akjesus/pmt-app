
<form id="salesForm" style ="margin-top: 20px; padding: 20px;">
    <h2>Sales Form</h2>
    <button id="populateInventoryBtn" class="btn btn-primary" type="button" onclick="populateInventories()">Populate Inventory</button>
    <table id="salesTable" class ="table">
        <thead>
            <tr>
                <th class="th">Item</th>
                <th class="th">Price</th>
                <th class="th">Qty</th>
                <th class="th">SubTotal</th>
                <th class="th"> </th>
            </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
    </table>
    <button type="button" onclick="addRow()" class="button">Add Item</button>
    <p class="total">Total: ₦<span id="totalAmount">0.00</span></p>
    <button type="submit" class="button">Submit Sale</button>
</form>
<script>
    const button = document.getElementById('populateInventoryBtn');
    let inventories = [];
    const populateInventories = async () => {
        const res = await fetch('http://127.0.0.1:8000/api/inventories');
        inventories = await res.json();
        console.log(inventories);
        addRow();
        button.disabled = true; // Disable button after populating
    };
    const items = Array.from(document.querySelectorAll('#itemsBody tr'))
        .map(row => {
            const input = row.querySelector('.item-search');
            const itemId = input.dataset.id;
            const qty = parseInt(row.querySelector('.qty').value) || 0;
            return itemId && qty > 0 ? { itemId, qty } : null;
        }).filter(x => x);
        function addRow() {
                const tbody = document.getElementById('itemsBody');
                const row = document.createElement('tr');
                row.innerHTML = `
    <td>
      <input type="text" class="item-search" oninput="handleItemSearch(this)" list="inventoryList" />
    </td>
    <td><input type="number" class="price" readonly /></td>
    <td><input type="number" class="qty" value="1" min="1" oninput="updateSubtotal(this)" /></td>
    <td><input type="number" class="subtotal" readonly /></td>
    <td><button type="button" onclick="removeRow(this)">Remove</button></td>`;
                tbody.appendChild(row);
                renderDatalist();
            }
            function renderDatalist() {
                    let datalist = document.getElementById('inventoryList');
                    if (!datalist) {
                        datalist = document.createElement('datalist');
                        datalist.id = 'inventoryList';
                        document.body.appendChild(datalist);
                    }
                    datalist.innerHTML = inventory.map(item =>
                        `<option value="${item.name}" data-id="${item._id}" data-price="${item.price}">`
                    ).join('');
                }

        function removeRow(btn) {
            btn.closest('tr').remove();
            calculateTotal();
        }

        function updatePrice(sel) {
            const row = sel.closest('tr');
            const sellingPrice = parseFloat(sel.selectedOptions[0].dataset.price || 0);
            row.querySelector('.price').value = sellingPrice.toFixed(2);
            updateSubtotal(row.querySelector('.qty'));
        }

        function updateSubtotal(qtyInput) {
            const row = qtyInput.closest('tr');
            const price = parseFloat(row.querySelector('.price').value) || 0;
            const qty = parseInt(qtyInput.value) || 0;
            const subtotal = price * qty;
            row.querySelector('.subtotal').value = subtotal.toFixed(2);
            calculateTotal();
        }
    function handleItemSearch(input) {
        const val = input.value.trim().toLowerCase();
        const row = input.closest('tr');
        const match = inventory.find(i => i.name.toLowerCase() === val);
        if (match) {
            input.dataset.id = match._id;
            row.querySelector('.price').value = match.price.toFixed(2);
            updateSubtotal(row.querySelector('.qty'));
        } else {
            input.removeAttribute('data-id');
            row.querySelector('.price').value = '';
            row.querySelector('.subtotal').value = '';
            calculateTotal();
        }
    }
        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.subtotal').forEach(el => {
                total += parseFloat(el.value) || 0;
            });
            document.getElementById('totalAmount').innerText = total.toFixed(2);
        }

        document.getElementById('salesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const items = Array.from(document.querySelectorAll('#itemsBody tr'))
                .map(row => {
                    const sel = row.querySelector('.item-select');
                    const qty = parseInt(row.querySelector('.qty').value) || 0;
                    return sel.value && qty > 0 ? { itemId: sel.value, qty } : null;
                }).filter(x => x);

            if (!items.length) return alert('Add at least one item.');

            const res = await fetch('http://localhost:3000/api/sales', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items })
            });

            if (res.ok) {
                alert('Sale recorded!');
                document.getElementById('itemsBody').innerHTML = '';
                addRow();
                calculateTotal();
            } else alert('Error saving sale');
        });
</script>
<h2>Sales Form</h2>
<form id="salesForm" id="salesForm" style ="margin-top: 20px; padding: 20px;">
    <table id="salesTable">
        <thead>
            <tr>
                <th class="th">Item</th>
                <th class="th">Price</th>
                <th class="th">Qty</th>
                <th class="th">SubTotal</th>
                <th class="th"> </th>>
            </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
    </table>
    <button type="button" onclick="addRow()">Add Item</button>
    <p class="total">Total: ₦<span id="totalAmount">0.00</span></p>
    <button type="submit">Submit Sale</button>
</form>

<script>
    let inventory = [];

    window.onload = async () => {
        const res = await fetch('http://localhost:3000/api/inventory');
        inventory = await res.json();
        addRow();
    };

    function renderDatalist() {
        let datalist = document.getElementById('inventoryList');
        if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = 'inventoryList';
            document.body.appendChild(datalist);
        }
        datalist.innerHTML = inventory.map(item =>
            `<option value="${item.name}" data-id="${item._id}" data-price="${item.price}">`
        ).join('');
    }

    function addRow() {
        const tbody = document.getElementById('itemsBody');
        const row = document.createElement('tr');
        row.innerHTML = `
        <td>
          <input type="text" class="item-search" oninput="handleItemSearch(this)" list="inventoryList" />
        </td>
        <td><input type="number" class="price" readonly /></td>
        <td><input type="number" class="qty" value="1" min="1" oninput="updateSubtotal(this)" /></td>
        <td><input type="number" class="subtotal" readonly /></td>
        <td><button type="button" onclick="removeRow(this)">Remove</button></td>`;
        tbody.appendChild(row);
        renderDatalist();
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        calculateTotal();
    }

    function handleItemSearch(input) {
        const val = input.value.trim().toLowerCase();
        const row = input.closest('tr');
        const match = inventory.find(i => i.name.toLowerCase() === val);
        if (match) {
            input.dataset.id = match._id;
            row.querySelector('.price').value = match.price.toFixed(2);
            updateSubtotal(row.querySelector('.qty'));
        } else {
            input.removeAttribute('data-id');
            row.querySelector('.price').value = '';
            row.querySelector('.subtotal').value = '';
            calculateTotal();
        }
    }

    function updateSubtotal(qtyInput) {
        const row = qtyInput.closest('tr');
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const qty = parseInt(qtyInput.value) || 0;
        const subtotal = price * qty;
        row.querySelector('.subtotal').value = subtotal.toFixed(2);
        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('.subtotal').forEach(el => {
            total += parseFloat(el.value) || 0;
        });
        document.getElementById('totalAmount').innerText = total.toFixed(2);
    }

    document.getElementById('salesForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const items = Array.from(document.querySelectorAll('#itemsBody tr'))
            .map(row => {
                const input = row.querySelector('.item-search');
                const itemId = input.dataset.id;
                const qty = parseInt(row.querySelector('.qty').value) || 0;
                return itemId && qty > 0 ? { itemId, qty } : null;
            }).filter(x => x);

        if (!items.length) return alert('Add at least one item.');

        const res = await fetch('http://localhost:3000/api/sales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items })
        });

        if (res.ok) {
            alert('Sale recorded!');
            document.getElementById('itemsBody').innerHTML = '';
            addRow();
            calculateTotal();
        } else alert('Error saving sale');
    });
</script>